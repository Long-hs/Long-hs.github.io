---
layout: post
title: "Kafkaç”Ÿäº§ç«¯é…ç½®ä¸ä»£ç æŒ‡å—"
subtitle: "æ·±å…¥äº†è§£Kafkaç”Ÿäº§ç«¯åŒæ­¥ä¸å¼‚æ­¥ç”Ÿäº§è€…é…ç½®åŠå®ç°"
header-img: "img/bg-walle.jpg"
tags: [Kafka, æŠ€æœ¯, æ¶ˆæ¯é˜Ÿåˆ—]
---

# ğŸ“– Kafkaç”Ÿäº§ç«¯é…ç½®ä¸ä»£ç æŒ‡å—

## å‰è¨€
ğŸ“¢ ç›¸å…³ä»£ç å·²ä¼ å…¥ GitHubï¼Œå¦‚æœè¦ä½¿ç”¨ Web ç«¯æµ‹è¯•ï¼Œåªéœ€åœ¨å¯åŠ¨æœåŠ¡åå…³é—­ Kafka å°±è¡Œã€‚ä¸‹é¢å°†è¯¦ç»†ä»‹ç» Kafka ç”Ÿäº§ç«¯çš„åŒæ­¥å’Œå¼‚æ­¥ç”Ÿäº§è€…çš„é…ç½®ä¸ä»£ç å®ç°ã€‚

## ğŸŒŸ ç”Ÿäº§ç«¯æ¦‚è¿°
ğŸ’¡ Kafka ç”Ÿäº§ç«¯ä¸»è¦æœ‰åŒæ­¥ç”Ÿäº§è€…ï¼ˆSyncProducerï¼‰å’Œå¼‚æ­¥ç”Ÿäº§è€…ï¼ˆAsyncProducerï¼‰ä¸¤ç§ç±»å‹ã€‚åŒæ­¥ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯æ—¶ä¼šç­‰å¾…æœåŠ¡å™¨ç¡®è®¤ï¼Œè€Œå¼‚æ­¥ç”Ÿäº§è€…åˆ™é€šè¿‡é€šé“å¼‚æ­¥å‘é€æ¶ˆæ¯ï¼Œæé«˜äº†å‘é€æ•ˆç‡ã€‚

## ğŸŒŸ åŒæ­¥ç”Ÿäº§è€…ï¼ˆSyncProducerï¼‰
### å‘é€æ¶ˆæ¯å‡½æ•°
```go:g:\Blog\Long-hs.github.io\_posts\2025-04-26-kafkaç”Ÿäº§è€…ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±.md
// SendMessage åŒæ­¥å‘é€æ¶ˆæ¯åˆ°æŒ‡å®šçš„topic
// å‚æ•°:
//   - message: è¦å‘é€çš„æ¶ˆæ¯å†…å®¹
//
// è¿”å›:
//   - error: å‘é€å¤±è´¥æ—¶è¿”å›é”™è¯¯
func (s *SyncProducerService) SendMessage(message string) error {
    // åˆ›å»ºç”Ÿäº§è€…æ¶ˆæ¯
    msg := &sarama.ProducerMessage{
        Topic: syncTopic,
        Value: sarama.StringEncoder(message),
    }

    log.Printf("%så¼€å§‹å‘é€æ¶ˆæ¯: topic=%s, message=%s", logPrefixSync, syncTopic, message)

    // å‘é€æ¶ˆæ¯å¹¶ç­‰å¾…ç»“æœ
    partition, offset, err := s.producer.SendMessage(msg)
    if err != nil {
        log.Printf("%sæ¶ˆæ¯å‘é€å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•: topic=%s, error=%v", logPrefixSync, syncTopic, err)
        return s.retrySend(msg, 5) // å¤±è´¥æ—¶è¿›è¡Œé‡è¯•
    }

    log.Printf("%sæ¶ˆæ¯å‘é€æˆåŠŸ: topic=%s, partition=%d, offset=%d",
        logPrefixSync, syncTopic, partition, offset)
    return nil
}
```

### é…ç½®acksæœºåˆ¶
ğŸ›¡ï¸ ä¸ºäº†ç¡®ä¿æ¶ˆæ¯å‘é€çš„å¯é æ€§ï¼Œæˆ‘ä»¬éœ€è¦é…ç½® Kafka çš„ acks æœºåˆ¶ã€‚è¯¥æœºåˆ¶å†³å®šäº†ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯æ—¶éœ€è¦ç­‰å¾…å¤šå°‘ä¸ªå‰¯æœ¬ç¡®è®¤æ¶ˆæ¯å·²å†™å…¥ï¼š
- `acks=0`ï¼ˆä¸å®‰å…¨ï¼‰ï¼šä¸ç­‰å¾…brokerç¡®è®¤ï¼Œå¯èƒ½ä¼šå› ç½‘ç»œä¸¢å¤±ã€‚
- `acks=1`ï¼ˆé»˜è®¤ï¼‰ï¼šä»…leaderç¡®è®¤ï¼Œè‹¥leaderæœªåŒæ­¥å‰¯æœ¬ï¼Œåˆ™ä¸¢å¤±ã€‚
- `acks=all`ï¼ˆå®‰å…¨ï¼‰ï¼š ç­‰å¾…æ‰€æœ‰ ISR å‰¯æœ¬ç¡®è®¤ï¼Œç¡®ä¿æ¶ˆæ¯è‡³å°‘å†™å…¥ä¸€ä¸ªå‰¯æœ¬ã€‚

ğŸ’¡ ä»¥ä¸‹ä»£ç å°† acks é…ç½®ä¸ºç­‰å¾…æ‰€æœ‰ ISR å‰¯æœ¬ç¡®è®¤ï¼Œè¿™æ˜¯æœ€å®‰å…¨çš„é…ç½®æ–¹å¼ã€‚
```go:g:\Blog\Long-hs.github.io\_posts\2025-04-26-kafkaç”Ÿäº§è€…ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±.md
config.Producer.RequiredAcks = sarama.WaitForAll
```

### å¯åŠ¨é‡è¯•æœºåˆ¶
ğŸ› ï¸ åŒæ­¥ç”Ÿäº§è€…éœ€è¦å¼€å¯ä¸€äº›é…ç½®ä»¥æ”¯æŒé‡è¯•æœºåˆ¶å’Œå¹‚ç­‰æ€§ï¼š
```go:g:\Blog\Long-hs.github.io\_posts\2025-04-26-kafkaç”Ÿäº§è€…ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±.md
// é…ç½®ç”Ÿäº§è€…å‚æ•°
config := sarama.NewConfig()
config.Producer.Return.Successes = true          // è¦æ±‚è¿”å›å‘é€æˆåŠŸç¡®è®¤ï¼ˆé»˜è®¤ç¦ç”¨ï¼‰
config.Producer.Idempotent = true                // å¯ç”¨å¹‚ç­‰æ€§ï¼Œç¡®ä¿æ¶ˆæ¯ä¸ä¼šé‡å¤å‘é€ï¼ˆå¯åŠ¨å¹‚ç­‰æ€§å¿…é¡»å¯åŠ¨acks=allå’Œè®¾ç½®MaxOpenRequests=1ï¼‰
config.Net.MaxOpenRequests = 1                   // é™åˆ¶æœ€å¤§å¹¶å‘è¯·æ±‚æ•°
config.Producer.RequiredAcks = sarama.WaitForAll // ç­‰å¾…æ‰€æœ‰å‰¯æœ¬ç¡®è®¤
config.Producer.Retry.Max = 5                    // æœ€å¤§é‡è¯•æ¬¡æ•°
```

### é‡è¯•å‘é€å‡½æ•°
ğŸ”„ å½“æ¶ˆæ¯å‘é€å¤±è´¥æ—¶ï¼Œä¼šè°ƒç”¨æ­¤å‡½æ•°è¿›è¡Œé‡è¯•ã€‚ä»¥ä¸‹æ˜¯å…·ä½“å®ç°ï¼š
```go:g:\Blog\Long-hs.github.io\_posts\2025-04-26-kafkaç”Ÿäº§è€…ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±.md
// retrySend åŒæ­¥é‡è¯•å‘é€æ¶ˆæ¯
// å‚æ•°:
//   - msg: è¦é‡è¯•å‘é€çš„æ¶ˆæ¯
//   - maxRetries: æœ€å¤§é‡è¯•æ¬¡æ•°
//
// è¿”å›:
//   - error: é‡è¯•å¤±è´¥æ—¶è¿”å›é”™è¯¯
func (s *SyncProducerService) retrySend(msg *sarama.ProducerMessage, maxRetries int) error {
    for i := 0; i <= maxRetries; i++ {
        log.Printf("%så¼€å§‹ç¬¬%dæ¬¡é‡è¯•: topic=%s", logPrefixSync, i+1, msg.Topic)

        // å°è¯•å‘é€æ¶ˆæ¯
        partition, offset, err := s.producer.SendMessage(msg)
        if err == nil {
            log.Printf("%sé‡è¯•å‘é€æˆåŠŸ: topic=%s, é‡è¯•æ¬¡æ•°=%d, partition=%d, offset=%d",
                logPrefixSync, msg.Topic, i+1, partition, offset)
            return nil
        }

        // å¦‚æœè¿˜å¯ä»¥é‡è¯•ä¸”é”™è¯¯å¯é‡è¯•ï¼Œåˆ™ç­‰å¾…åç»§ç»­
        if i < maxRetries && isRetryableError(err) {
            backoff := time.Duration(1<<i) * 100 * time.Millisecond // æŒ‡æ•°é€€é¿
            log.Printf("%sé‡è¯•å‘é€å¤±è´¥: topic=%s, é‡è¯•æ¬¡æ•°=%d, ç­‰å¾…æ—¶é—´=%v, é”™è¯¯=%v",
                logPrefixSync, msg.Topic, i+1, backoff, err)
            time.Sleep(backoff)
            continue
        }

        // é‡è¯•å¤±è´¥æˆ–è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
        log.Printf("%sé‡è¯•ç»ˆæ­¢: topic=%s, é‡è¯•æ¬¡æ•°=%d, é”™è¯¯=%v",
            logPrefixSync, msg.Topic, i+1, err)
        return err
    }
    return nil
}
```

## ğŸŒŸ å¼‚æ­¥ç”Ÿäº§è€…ï¼ˆAsyncProducerï¼‰
### å‘é€æ¶ˆæ¯å‡½æ•°
ğŸš€ å¼‚æ­¥å‘é€æ¶ˆæ¯éœ€è¦ä½¿ç”¨é€šé“ï¼Œä»¥ä¸‹æ˜¯å…·ä½“å®ç°ï¼š
```go:g:\Blog\Long-hs.github.io\_posts\2025-04-26-kafkaç”Ÿäº§è€…ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±.md
// SendMessage å¼‚æ­¥å‘é€æ¶ˆæ¯
// å‚æ•°:
//   - message: è¦å‘é€çš„æ¶ˆæ¯å†…å®¹
func (s *AsyncProducerService) SendMessage(message string) {
    // åˆ›å»ºç”Ÿäº§è€…æ¶ˆæ¯
    msg := &sarama.ProducerMessage{
        Topic: asyncTopic,
        Value: sarama.StringEncoder(message),
    }
    log.Printf("%så‘é€æ¶ˆæ¯: topic=%s, message=%s", logPrefixAsync, asyncTopic, message)
    // å°†æ¶ˆæ¯å‘é€åˆ°è¾“å…¥é€šé“
    s.producer.Input() <- msg
}
```

### é…ç½®
ğŸ› ï¸ å¼‚æ­¥ç”Ÿäº§è€…çš„é…ç½®ä¹Ÿéœ€è¦è€ƒè™‘å¹‚ç­‰æ€§å’Œé”™è¯¯å¤„ç†ï¼š
```go:g:\Blog\Long-hs.github.io\_posts\2025-04-26-kafkaç”Ÿäº§è€…ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±.md
// é…ç½®ç”Ÿäº§è€…å‚æ•°
config := sarama.NewConfig()
config.Producer.RequiredAcks = sarama.WaitForAll // ç­‰å¾…æ‰€æœ‰å‰¯æœ¬ç¡®è®¤
config.Producer.Idempotent = true                // å¯ç”¨å¹‚ç­‰æ€§ï¼Œç¡®ä¿æ¶ˆæ¯ä¸ä¼šé‡å¤å‘é€
config.Producer.Retry.Max = 5                    // æœ€å¤§é‡è¯•æ¬¡æ•°
config.Net.MaxOpenRequests = 1                   // æœ€å¤§å¹¶å‘è¯·æ±‚æ•°
config.Producer.Return.Errors = true             // è¿”å›é”™è¯¯ä¿¡æ¯
```

### é”™è¯¯å¤„ç†
ğŸš¨ ä¸ºäº†åŠæ—¶å¤„ç†å¼‚æ­¥å‘é€è¿‡ç¨‹ä¸­çš„é”™è¯¯ï¼Œæˆ‘ä»¬éœ€è¦ç›‘å¬é”™è¯¯é€šé“å¹¶å¯¹å¯é‡è¯•çš„é”™è¯¯è¿›è¡Œé‡è¯•ï¼š
```go:g:\Blog\Long-hs.github.io\_posts\2025-04-26-kafkaç”Ÿäº§è€…ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±.md
// errorHanding å¤„ç†å¼‚æ­¥å‘é€è¿‡ç¨‹ä¸­çš„é”™è¯¯
// å¯åŠ¨ä¸€ä¸ªåç¨‹ç›‘å¬é”™è¯¯é€šé“ï¼Œå¯¹å¯é‡è¯•çš„é”™è¯¯è¿›è¡Œé‡è¯•
func (s *AsyncProducerService) errorHanding() {
    log.Printf("%så¯åŠ¨é”™è¯¯å¤„ç†åç¨‹", logPrefixAsync)
    go func() {
        // ä»é”™è¯¯é€šé“ä¸­è¯»å–é”™è¯¯
        for result := range s.producer.Errors() {
            if isRetryableError(result.Err) {
                log.Printf("%sæ¶ˆæ¯å‘é€å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•: topic=%s, partition=%d, error=%v",
                    logPrefixAsync, result.Msg.Topic, result.Msg.Partition, result.Err)
                s.retrySend(result.Msg, 5)
            } else {
                log.Printf("%sæ¶ˆæ¯å‘é€å¤±è´¥(ä¸å¯é‡è¯•): topic=%s, partition=%d, error=%v",
                    logPrefixAsync, result.Msg.Topic, result.Msg.Partition, result.Err)
            }
        }
    }()
}

// retrySend å¼‚æ­¥é‡è¯•å‘é€æ¶ˆæ¯
// å‚æ•°:
//   - msg: è¦é‡è¯•å‘é€çš„æ¶ˆæ¯
//   - maxRetries: æœ€å¤§é‡è¯•æ¬¡æ•°
//
// è¿”å›:
//   - error: é‡è¯•å¤±è´¥æ—¶è¿”å›é”™è¯¯
func (s *AsyncProducerService) retrySend(msg *sarama.ProducerMessage, maxRetries uint16) error {
    value := make([]byte, 2)
    var retryCount uint16 = 1

    // æ£€æŸ¥æ¶ˆæ¯å¤´ä¸­æ˜¯å¦å·²æœ‰é‡è¯•è®¡æ•°
    for i := range msg.Headers {
        if string(msg.Headers[i].Key) == "retry_count" {
            retryCount = binary.BigEndian.Uint16(msg.Headers[i].Value) + 1
            value := make([]byte, 2)
            binary.BigEndian.PutUint16(value, retryCount)
            msg.Headers[i].Value = value
            break
        }
    }

    // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°
    if retryCount > maxRetries {
        log.Printf("%sæ¶ˆæ¯é‡å‘å¤±è´¥: topic=%s, é‡è¯•æ¬¡æ•°=%d, è¶…è¿‡é‡è¯•æ¬¡æ•°ä¸Šé™=%d",
            logPrefixAsync, msg.Topic, retryCount, maxRetries)
        return errors.New("æ¶ˆæ¯é‡å‘å¤±è´¥ï¼Œè¶…è¿‡é‡è¯•æ¬¡æ•°ä¸Šé™")
    }

    // å¦‚æœæ˜¯é¦–æ¬¡é‡è¯•ï¼Œæ·»åŠ é‡è¯•è®¡æ•°å¤´
    if retryCount == 1 {
        binary.BigEndian.PutUint16(value, retryCount)
        msg.Headers = append(msg.Headers, sarama.RecordHeader{
            Key:   []byte("retry_count"),
            Value: value,
        })
    }

    log.Printf("%så¼€å§‹ç¬¬%dæ¬¡é‡è¯•: topic=%s", logPrefixAsync, retryCount, msg.Topic)
    // å°†æ¶ˆæ¯é‡æ–°å‘é€åˆ°è¾“å…¥é€šé“
    s.producer.Input() <- msg
    return nil
}
```

## æ€»ç»“
ğŸ“ Kafka ç”Ÿäº§ç«¯çš„åŒæ­¥å’Œå¼‚æ­¥ç”Ÿäº§è€…å„æœ‰ä¼˜ç¼ºç‚¹ï¼ŒåŒæ­¥ç”Ÿäº§è€…é€‚åˆå¯¹æ¶ˆæ¯å¯é æ€§è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ï¼Œè€Œå¼‚æ­¥ç”Ÿäº§è€…åˆ™æ›´é€‚åˆå¯¹æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ã€‚é€šè¿‡åˆç†é…ç½® acks æœºåˆ¶ã€é‡è¯•æœºåˆ¶å’Œå¹‚ç­‰æ€§ï¼Œå¯ä»¥æé«˜æ¶ˆæ¯å‘é€çš„å¯é æ€§å’Œæ•ˆç‡ã€‚ğŸ‰